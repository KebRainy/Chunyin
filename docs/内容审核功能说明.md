# 内容审核功能说明（本地 Python，可选）

项目支持一个**可选**的本地 Python 审核服务，用于在以下场景做“速度优先”的违规检测：
- 发布动态（文本 + 动态图片）
- 发布动态评论（文本）
- 发布 Wiki 评论（文本）

默认不开启，避免其他同学拉项目后因缺少 Python 环境而启动失败。

## 1. 审核能力（速度优先，准确度非目标）

### 文本
- 广告/引流：链接、手机号/微信/QQ 等联系方式、常见引流关键词
- 色情：常见关键词（中英文）与变体归一化
  - 中文适配：全角/半角归一、繁转简（OpenCC）、中文数字转阿拉伯数字、去除常见分隔符（提升“加-微-信”这类拆分写法命中）

### 图片
- 广告/引流：二维码检测（OpenCV QRCodeDetector）
- 色情：OpenNSFW（ResNet，Caffe 模型，OpenCV DNN 推理）

> 说明：图片审核没有“人工复核队列”，因此 Python 返回 `REVIEW/BLOCK` 时后端会直接拦截发布（避免放行明显广告图/色情图）。

## 2. 启动 Python 服务

目录：`backend/python`

### Windows（推荐）

```bat
cd backend\python
run_python_server.bat
```

### macOS / Linux

```bash
cd backend/python
bash run_python_server.sh
```

默认监听：`http://127.0.0.1:8099`  
可通过环境变量 `MODERATION_PORT` 修改端口。

## 3. 后端配置

编辑 `backend/src/main/resources/application.properties`：

```properties
moderation.python.enabled=true
moderation.python.base-url=http://127.0.0.1:8099
moderation.python.timeout-ms=800
moderation.python.fail-open=true
```

- `fail-open=true`：Python 服务挂了/超时就放行（更“稳”）
- `fail-open=false`：Python 服务挂了/超时就拒绝发布（更“严”）

## 4. 常见报错排查

### 4.1 Python 日志出现 `Unsupported upgrade request` / `Invalid HTTP request received`

原因通常是客户端在尝试 HTTP/2 upgrade（h2c）或发送了非 HTTP/1.1 的内容。

后端已通过 `PythonModerationClient` 强制使用 `HTTP/1.1` 规避此问题；如果你本地仍出现，优先确认：
- 后端是否已更新到最新代码
- `moderation.python.base-url` 是否指向正确端口

### 4.2 `POST /v1/moderate/text` 返回 422

代表请求体字段不符合接口模型。

接口需要 JSON 字段：
- 文本：`text`
- 图片：`image_base64`

后端会同时兼容发送 `text/content` 和 `image_base64/imageBase64`，一般不会再触发该问题。

## 5. 接口约定

- `POST /v1/moderate/text`：`{"text": "...", "scene": "TEXT"}`
- `POST /v1/moderate/image`：`{"image_base64": "...", "mime_type": "image/jpeg", "scene": "POST_IMAGE"}`

返回：
- `action`: `ALLOW | REVIEW | BLOCK`
- `reasons`: 命中的规则原因（用于 debug）

## 6. 模型文件说明（OpenNSFW）

图片色情检测依赖 OpenNSFW 模型文件，启动脚本会自动下载到：
- `backend/python/models/open_nsfw/deploy.prototxt`
- `backend/python/models/open_nsfw/resnet_50_1by2_nsfw.caffemodel`

如需手动下载：

```bash
cd backend/python
python download_models.py
```
