# 推荐系统说明文档

## 概述

本推荐系统采用**混合推荐策略**，结合三种推荐算法来生成"猜你喜欢"的帖子推荐。

## 推荐流程

### 1. 候选动态获取
- 排除用户已看过的动态
- 只考虑最近90天内的动态
- 最多获取1000条候选动态

### 2. 三种推荐算法并行计算

#### 2.1 基于内容推荐 (ContentBasedRecommender) - 权重40%

**算法原理：**
- 基于用户的历史行为（浏览、点赞、收藏、评论）构建用户偏好画像
- 提取用户偏好的标签和地点
- 计算候选动态与用户偏好的相似度

**计算步骤：**
1. **构建用户偏好画像**
   - 分析用户最近30天的行为数据
   - 提取用户互动过的动态的标签和地点
   - 根据行为类型赋予权重：
     - 浏览: 1.0
     - 点赞: 2.0
     - 收藏: 3.0
     - 评论: 1.5
     - 分享: 2.0
   - 归一化标签和地点权重

2. **计算相似度**
   - **标签相似度**：使用余弦相似度算法
     ```
     similarity = Σ(userWeight[tag] * postWeight[tag]) / 
                  (||userVector|| * ||postVector||)
     ```
   - **地点匹配度**：直接查找用户对该地点的偏好权重
   - **综合分数** = 0.7 × 标签相似度 + 0.3 × 地点匹配度

**适用场景：**
- 新用户冷启动（即使没有相似用户，也能基于内容推荐）
- 用户有明确的标签和地点偏好

#### 2.2 协同过滤推荐 (CollaborativeFilteringRecommender) - 权重40%

**算法原理：**
- 找到与当前用户行为相似的其他用户（Top-K，默认10个）
- 推荐相似用户喜欢但当前用户未看过的动态

**计算步骤：**
1. **查找相似用户**
   - 获取所有有行为的用户
   - 计算用户互动向量（基于浏览、点赞、收藏、评论等行为）
   - 使用余弦相似度计算用户相似度：
     ```
     cosine = Σ(vector1[i] * vector2[i]) / 
              (||vector1|| * ||vector2||)
     ```
   - 返回最相似的K个用户

2. **获取相似用户喜欢的动态**
   - 统计相似用户对动态的点赞、收藏、评论行为
   - 过滤掉当前用户已看过的动态

3. **计算推荐分数**
   - 按相似度加权求和：
     ```
     score = Σ(用户相似度 × 行为权重)
     ```
   - 行为权重：点赞2.0，收藏3.0，评论1.5

**适用场景：**
- 用户有足够的历史行为数据
- 能发现用户的潜在兴趣（即使内容特征不明显）

#### 2.3 热度排行推荐 (HotScoreCalculator) - 权重20%

**算法原理：**
- 综合多个互动指标和时间衰减计算热度分数
- 保证内容的时效性

**计算公式：**
```
基础分 = viewCount×0.1 + likeCount×2 + 
         favoriteCount×3 + commentCount×1.5

时间衰减 = 1 / (1 + hoursSinceCreated/24)

热度分 = 基础分 × 时间衰减
```

**时间衰减示例：**
- 0小时：衰减系数 = 1.0（最新内容）
- 24小时：衰减系数 = 0.5
- 48小时：衰减系数 = 0.33
- 72小时：衰减系数 = 0.25

**适用场景：**
- 保证推荐内容的时效性
- 平衡热门内容和个性化推荐

### 3. 结果合并与排序

1. **按权重调整分数**
   - 基于内容推荐分数 × 0.4
   - 协同过滤推荐分数 × 0.4
   - 热度排行推荐分数 × 0.2

2. **去重**
   - 如果同一动态出现在多个推荐结果中，保留分数最高的

3. **排序**
   - 按最终分数降序排序
   - 取Top-N（N为用户请求的数量）

4. **转换为VO返回**

## 推荐结果示例

假设用户A的推荐结果：

| 动态ID | 内容推荐分数 | 协同过滤分数 | 热度分数 | 最终分数 | 推荐原因 |
|--------|------------|------------|---------|---------|---------|
| 101    | 0.8        | 0.6        | 0.5     | 0.62    | 标签匹配+相似用户喜欢 |
| 102    | 0.3        | 0.9        | 0.4     | 0.60    | 相似用户喜欢 |
| 103    | 0.7        | 0.2        | 0.8     | 0.52    | 标签匹配+热门内容 |

最终推荐顺序：101 > 102 > 103

## 特殊情况处理

1. **未登录用户**
   - 直接返回热门动态（按热度分数排序）

2. **新用户（无历史行为）**
   - 基于内容推荐无法工作，主要依赖热度排行推荐
   - 随着用户行为积累，个性化程度逐渐提高

3. **候选动态为空**
   - 返回热门动态作为兜底

4. **推荐结果为空**
   - 返回热门动态作为兜底

## 优化建议

1. **参数调优**
   - 可以调整三种算法的权重比例
   - 可以调整时间衰减的衰减速度
   - 可以调整行为权重

2. **性能优化**
   - 可以缓存用户偏好画像
   - 可以缓存相似用户列表
   - 可以使用异步计算

3. **算法改进**
   - 可以加入深度学习模型
   - 可以加入实时反馈机制
   - 可以加入多样性保证

## 代码结构

```
backend/src/main/java/com/example/demo1/
├── algorithm/
│   ├── ContentBasedRecommender.java      # 基于内容推荐器
│   ├── CollaborativeFilteringRecommender.java  # 协同过滤推荐器
│   └── HotScoreCalculator.java           # 热度分数计算器
├── dto/response/
│   └── RecommendationResult.java         # 推荐结果DTO
└── service/
    └── RecommendationService.java         # 推荐服务（协调器）
```

## 总结

"猜你喜欢"的帖子是通过以下方式得出的：

1. **分析你的历史行为**（浏览、点赞、收藏、评论）来了解你的偏好
2. **找到和你相似的用户**，看看他们喜欢什么
3. **结合热门内容**，保证推荐的新鲜度
4. **综合三种算法的结果**，按权重合并后排序
5. **返回最符合你兴趣的Top-N动态**

这样的混合策略既保证了推荐的个性化，又保证了内容的多样性和时效性。

