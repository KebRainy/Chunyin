"use strict";(self["webpackChunkdemo2"]=self["webpackChunkdemo2"]||[]).push([[363],{707:function(e,a,s){s.d(a,{_z:function(){return u},iA:function(){return r}});var l=s(7277);const t=()=>(0,l.A)({url:"/messages",method:"get"}),n=e=>(0,l.A)({url:`/messages/with/${e}`,method:"get"}),u=(e,a)=>(0,l.A)({url:`/messages/with/${e}`,method:"post",data:a}),r={fetchConversations:t,fetchConversationWith:n,sendMessage:u}},1363:function(e,a,s){s.r(a),s.d(a,{default:function(){return W}});s(8111),s(2489),s(116);var l=s(641),t=s(33),n=s(953),u=s(3751),r=s(707),i=s(163),c=s(4353),o=s.n(c),v=s(6400);const d={class:"messages-container"},m={class:"messages-layout"},k={class:"conversations-panel"},p={class:"conversations-list"},h=["onClick"],f={class:"conv-info"},g={class:"conv-user"},y={class:"conv-preview"},C={key:0,class:"unread-badge"},b={class:"chat-section"},L={class:"chat-panel"},w={key:0,class:"no-conversation"},_={key:1,class:"chat-body"},R={class:"chat-header"},E={class:"message-content"},K={class:"message-bubble"},X={class:"message-time"};var A={__name:"Messages",setup(e){const a=(0,n.KR)(""),s=(0,n.KR)(null),c=(0,n.KR)(""),A=(0,n.KR)([]),F=(0,n.KR)([]),V=(0,n.KR)(null),W=(0,v.k)(),M=(0,l.EW)(()=>a.value?A.value.filter(e=>e.peer?.username?.includes(a.value)):A.value),$=(0,l.EW)(()=>A.value.find(e=>e.peer?.id===s.value)?.peer),z=e=>e?o()(e).format("YYYY.MM.DD HH:mm"):"",I=()=>{(0,l.dY)(()=>{const e=V.value;e&&(e.scrollTop=e.scrollHeight)})},U=async()=>{try{const e=await r.iA.fetchConversations();A.value=e.data||[],!s.value&&A.value.length>0&&Y(A.value[0].peer.id)}catch(e){i.nk.error("加载私信失败")}},Y=async e=>{s.value=e;try{const a=await r.iA.fetchConversationWith(e);F.value=a.data||[],I()}catch(a){i.nk.error("加载对话失败")}},x=async()=>{if(c.value.trim()&&s.value)try{await r.iA.sendMessage(s.value,{content:c.value}),c.value="",await Y(s.value),await U()}catch(e){i.nk.error("发送失败，请稍后再试")}};return(0,l.sV)(()=>{U()}),(e,r)=>{const i=(0,l.g2)("el-input"),o=(0,l.g2)("el-avatar"),v=(0,l.g2)("el-empty"),A=(0,l.g2)("el-button");return(0,l.uX)(),(0,l.CE)("div",d,[(0,l.Lk)("div",m,[(0,l.Lk)("div",k,[r[2]||(r[2]=(0,l.Lk)("h3",null,"消息",-1)),(0,l.bF)(i,{modelValue:a.value,"onUpdate:modelValue":r[0]||(r[0]=e=>a.value=e),placeholder:"搜索会话",clearable:"",style:{"margin-bottom":"16px"}},null,8,["modelValue"]),(0,l.Lk)("div",p,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(M.value,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.peer.id,class:(0,t.C4)(["conversation-item",{active:s.value===e.peer.id}]),onClick:a=>Y(e.peer.id)},[(0,l.bF)(o,{src:e.peer.avatarUrl,size:40,alt:`${e.peer.username||"用户"}的头像`},null,8,["src","alt"]),(0,l.Lk)("div",f,[(0,l.Lk)("div",g,(0,t.v_)(e.peer.username),1),(0,l.Lk)("div",y,(0,t.v_)(e.lastMessage),1)]),e.unreadCount>0?((0,l.uX)(),(0,l.CE)("div",C,(0,t.v_)(e.unreadCount),1)):(0,l.Q3)("",!0)],10,h))),128))])]),(0,l.Lk)("div",b,[(0,l.Lk)("div",L,[s.value?((0,l.uX)(),(0,l.CE)("div",_,[(0,l.Lk)("div",R,[(0,l.Lk)("h3",null,(0,t.v_)($.value?.username),1)]),(0,l.Lk)("div",{class:"messages-list",ref_key:"chatBodyRef",ref:V},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(F.value,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:(0,t.C4)(["message-item",e.mine?"self":"other"])},[e.mine?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.Wv)(o,{key:0,src:$.value?.avatarUrl,size:32,alt:`${$.value?.username||"用户"}的头像`},null,8,["src","alt"])),(0,l.Lk)("div",E,[(0,l.Lk)("div",K,[(0,l.Lk)("p",null,(0,t.v_)(e.content),1)]),(0,l.Lk)("span",X,(0,t.v_)(z(e.createdAt)),1)]),e.mine?((0,l.uX)(),(0,l.Wv)(o,{key:1,src:(0,n.R1)(W).userInfo?.avatarUrl,size:32,alt:`${(0,n.R1)(W).userInfo?.username||"我的"}的头像`},null,8,["src","alt"])):(0,l.Q3)("",!0)],2))),128))],512)])):((0,l.uX)(),(0,l.CE)("div",w,[(0,l.bF)(v,{description:"选择一个会话开始聊天"})]))]),(0,l.Lk)("div",{class:(0,t.C4)(["chat-footer",{disabled:!s.value}])},[(0,l.bF)(i,{modelValue:c.value,"onUpdate:modelValue":r[1]||(r[1]=e=>c.value=e),type:"textarea",autosize:{minRows:3,maxRows:5},placeholder:s.value?"输入消息...":"选择一个会话以发送消息",disabled:!s.value,onKeydown:(0,u.jR)((0,u.D$)(x,["exact","prevent"]),["enter"])},null,8,["modelValue","placeholder","disabled","onKeydown"]),(0,l.bF)(A,{type:"primary",disabled:!s.value,onClick:x},{default:(0,l.k6)(()=>[...r[3]||(r[3]=[(0,l.eW)("发送",-1)])]),_:1},8,["disabled"])],2)])])])}}},F=s(6262);const V=(0,F.A)(A,[["__scopeId","data-v-3316e3eb"]]);var W=V}}]);
//# sourceMappingURL=363.f34e47c7.js.map