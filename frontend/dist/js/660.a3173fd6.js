"use strict";(self["webpackChunkChunyin"]=self["webpackChunkChunyin"]||[]).push([[660],{8930:function(e,t,l){l.d(t,{Dz:function(){return i},ET:function(){return s},FW:function(){return a},MC:function(){return m},Q5:function(){return u},Wb:function(){return d},dV:function(){return r},ko:function(){return v},m6:function(){return o},xl:function(){return k},zj:function(){return c}});var n=l(7277);const a=e=>(0,n.A)({url:"/wiki/pages",method:"get",params:e}),s=e=>(0,n.A)({url:`/wiki/pages/${e}`,method:"get"}),i=e=>(0,n.A)({url:`/wiki/pages/${e}/history`,method:"get"}),r=(e,t)=>(0,n.A)({url:`/wiki/pages/${e}/history/${t}`,method:"get"}),o=(e,t)=>(0,n.A)({url:`/wiki/pages/${e}/history/${t}/restore`,method:"post"}),u=e=>(0,n.A)({url:`/wiki/pages/${e}/discussions`,method:"get"}),c=(e,t)=>(0,n.A)({url:`/wiki/pages/${e}/discussions`,method:"post",data:t}),d=()=>(0,n.A)({url:"/wiki/pages/stats",method:"get"}),m=e=>(0,n.A)({url:"/wiki/pages",method:"post",data:e}),k=(e,t)=>(0,n.A)({url:`/wiki/pages/${e}`,method:"put",data:t}),v=e=>(0,n.A)({url:`/wiki/pages/${e}/favorite`,method:"post"})},9660:function(e,t,l){l.r(t),l.d(t,{default:function(){return j}});l(4114),l(8111),l(2489),l(1701),l(3110),l(7642),l(8004),l(3853),l(5876),l(2475),l(5024),l(1698),l(716);var n=l(641),a=l(33),s=l(953),i=l(3751),r=l(5220),o=l(8930),u=l(7277);const c=e=>(0,u.A)({url:`/files/${e}`,method:"delete"});var d=l(163),m=l(7918),k=l(8548),v=l(3263),p=l(9418);const f={class:"editor-page"},g={class:"header"},h={class:"eyebrow"},y={key:0,class:"status-bar"},b={class:"status-text"},w={class:"header-actions"},_={class:"editor-grid"},C={class:"editor-panel"},$={class:"toolbar"},L={class:"toolbar-group"},F={class:"toolbar-group"},S={class:"toolbar-group"},x={class:"toolbar-group"},W={class:"editor-wrapper"},E={class:"editor-stats"},R={key:0,class:"uploaded-images"},z={class:"images-list"},A=["src","alt"],T={class:"preview-panel"},V={class:"preview-header"},K={class:"preview-wrapper"},I={key:0,class:"preview-toc"},X=["onClick"],B=["innerHTML"];var M={__name:"WikiEditor",setup(e){const t=(0,r.lq)(),l=(0,r.rd)(),u=(0,s.KR)(!1),M=(0,s.KR)(!1),Q=(0,s.KR)([]),q=(0,s.KR)(null),j=(0,s.KR)(null),D=(0,s.KR)(!0),H=(0,s.KR)(""),O=(0,s.KR)(!1),U=(0,s.KR)(""),Y=(0,s.Kh)({title:"",summary:"",content:"",editSummary:""});let J=null,N=null,Z="";const G=new v.A({html:!0,linkify:!0,breaks:!0}),P=(0,n.EW)(()=>Y.content?p.A.sanitize(G.render(Y.content)):'<p class="empty">开始输入内容，实时预览会显示在这里</p>'),ee=(0,n.EW)(()=>Y.content?Y.content.split("\n").filter(e=>/^#{1,6}\s+/.test(e)).map(e=>{const t=e.match(/^#+/)[0].length;return{level:t,text:e.replace(/^#+/,"").trim()}}):[]),te=(0,n.EW)(()=>{const e=Y.content||"",t=e.trim()?e.trim().split(/\s+/).length:0,l=e.length,n=e.split("\n").length;return{words:t,chars:l,lines:n}}),le=(0,n.EW)(()=>!!t.params.id),ne=(e,t,l="")=>{if(!q.value)return;const a=q.value.$el.querySelector("textarea");if(!a)return;const s=a.selectionStart,i=a.selectionEnd,r=Y.content.substring(s,i),o=r?`${e}${r}${t}`:`${e}${l}${t}`;Y.content=Y.content.substring(0,s)+o+Y.content.substring(i),(0,n.dY)(()=>{const e=s+o.length;a.setSelectionRange(e,e),a.focus()})},ae=()=>{if(!q.value)return;const e=q.value.$el.querySelector("textarea");if(!e)return;const t=e.selectionStart,l=e.selectionEnd,a=Y.content.substring(t,l),s=a?`\`\`\`\n${a}\n\`\`\``:"```\n// 代码内容\n```";Y.content=Y.content.substring(0,t)+s+Y.content.substring(l),(0,n.dY)(()=>{const l=a?t+s.length:t+s.length-10;e.setSelectionRange(l,l),e.focus()})},se=()=>{if(!q.value)return;const e=q.value.$el.querySelector("textarea");if(!e)return;const t=e.selectionStart,l=e.selectionEnd,a=Y.content.substring(t,l),s=a?`[${a}](https://)`:"[链接文本](https://)";Y.content=Y.content.substring(0,t)+s+Y.content.substring(l),(0,n.dY)(()=>{const l=a?t+s.length-1:t+s.length-9;e.setSelectionRange(l,l),e.focus()})},ie=e=>{if(!j.value)return;const t=j.value.querySelectorAll("h1, h2, h3, h4, h5, h6");for(const l of t)if(l.textContent.trim()===e){l.scrollIntoView({behavior:"smooth",block:"center"}),l.style.backgroundColor="#e6f7ff",setTimeout(()=>{l.style.backgroundColor=""},1e3);break}},re=()=>{D.value=!D.value},oe=e=>{const t=e.type.startsWith("image/"),l=e.size/1024/1024<5;return t||d.nk.error("只能上传图片"),l||d.nk.error("图片需小于 5MB"),t&&l&&(M.value=!0),t&&l},ue=e=>{if(M.value=!1,200===e.code&&e.data?.url){const t=e.data.url,l=`![图片说明](${t})`;if(q.value){const e=q.value.$el.querySelector("textarea");if(e){const t=e.selectionStart,a=Y.content?`\n\n${l}\n\n`:l;Y.content=Y.content.substring(0,t)+a+Y.content.substring(t),(0,n.dY)(()=>{e.setSelectionRange(t+a.length,t+a.length),e.focus()})}else Y.content=Y.content?`${Y.content}\n\n${l}`:l}else Y.content=Y.content?`${Y.content}\n\n${l}`:l;d.nk.success("图片已插入")}else d.nk.error("上传失败")},ce=()=>{M.value=!1,d.nk.error("上传失败，请稍后再试")},de=async e=>{const t=e.url.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),l=new RegExp(`!\\[[^\\]]*\\]\\(${t}\\)`,"g");if(Y.content=(Y.content||"").replace(l,"").replace(/\n{3,}/g,"\n\n").trim(),e.uuid)try{await c(e.uuid),d.nk.success("图片已删除")}catch(n){d.nk.error(n.response?.data?.message||"删除失败")}else d.nk.success("图片引用已移除")},me=()=>{if(!Y.content)return void(Q.value=[]);const e=/!\[[^\]]*]\((.*?)\)/g,t=new Set,l=[];let n;while(null!==(n=e.exec(Y.content))){const e=n[1]?.trim();if(!e||t.has(e))continue;t.add(e);const a=e.match(/\/(?:api\/)?files\/([a-zA-Z0-9-]+)/);l.push({uid:a?a[1]:`${e}-${l.length}`,url:e,uuid:a?a[1]:null})}Q.value=l},ke=()=>{if(!Y.title&&!Y.content)return;const e=le.value?`wiki_draft_${t.params.id}`:"wiki_draft_new",l={title:Y.title,summary:Y.summary,content:Y.content,editSummary:Y.editSummary,savedAt:(new Date).toISOString()};localStorage.setItem(e,JSON.stringify(l)),H.value="saved",setTimeout(()=>{H.value=""},2e3)},ve=()=>{const e=le.value?`wiki_draft_${t.params.id}`:"wiki_draft_new",l=localStorage.getItem(e);if(l)try{const e=JSON.parse(l);return e}catch(n){return null}return null},pe=()=>{const e=le.value?`wiki_draft_${t.params.id}`:"wiki_draft_new";localStorage.removeItem(e)},fe=async()=>{if(!le.value){const e=ve();if(e)try{await m.s.confirm("检测到未保存的草稿，是否恢复？","恢复草稿",{confirmButtonText:"恢复",cancelButtonText:"放弃",type:"info"}),Object.assign(Y,{title:e.title||"",summary:e.summary||"",content:e.content||"",editSummary:e.editSummary||""}),U.value=Y.content,Z=Y.content}catch{pe()}return}try{const e=await(0,o.ET)(t.params.id);Object.assign(Y,{title:e.data.title||"",summary:e.data.summary||"",content:e.data.content||"",editSummary:""}),U.value=Y.content,Z=Y.content}catch(e){d.nk.error("加载词条失败")}},ge=async()=>{if(Y.title.trim()&&Y.content.trim()){u.value=!0;try{le.value?(await(0,o.xl)(t.params.id,{title:Y.title,summary:Y.summary,content:Y.content,editSummary:Y.editSummary}),d.nk.success("已提交修改，等待审核")):(await(0,o.MC)({title:Y.title,summary:Y.summary,content:Y.content,editSummary:Y.editSummary}),d.nk.success("已提交，等待审核")),pe(),O.value=!1,l.push("/wiki")}catch(e){console.error("提交失败:",e),d.nk.error(e.response?.data?.message||"提交失败，请稍后再试")}finally{u.value=!1}}else d.nk.warning("标题和正文不能为空")},he=async()=>{if(O.value)try{await m.s.confirm("您有未保存的更改，确定要离开吗？","确认离开",{confirmButtonText:"离开",cancelButtonText:"取消",type:"warning"}),l.push("/wiki")}catch{}else l.push("/wiki")};return(0,n.sV)(()=>{fe(),(0,n.wB)(()=>[Y.title,Y.summary,Y.content],()=>{O.value=Y.content!==U.value,N&&clearTimeout(N),N=setTimeout(()=>{O.value&&(H.value="saving",ke())},2e3)},{deep:!0}),(0,n.wB)(()=>Y.content,()=>{J&&clearTimeout(J),J=setTimeout(()=>{me()},200)},{immediate:!0}),window.addEventListener("beforeunload",e=>{O.value&&(e.preventDefault(),e.returnValue="您有未保存的更改，确定要离开吗？")})}),(0,n.xo)(()=>{J&&clearTimeout(J),N&&clearTimeout(N),window.removeEventListener("beforeunload",()=>{})}),(e,t)=>{const l=(0,n.g2)("el-icon"),r=(0,n.g2)("el-button"),o=(0,n.g2)("el-input"),c=(0,n.g2)("el-form-item"),d=(0,n.g2)("el-button-group"),m=(0,n.g2)("el-upload"),v=(0,n.g2)("el-form"),p=(0,n.g2)("el-card");return(0,n.uX)(),(0,n.CE)("div",f,[(0,n.bF)(p,null,{header:(0,n.k6)(()=>[(0,n.Lk)("div",g,[(0,n.Lk)("div",null,[(0,n.Lk)("p",h,(0,a.v_)(le.value?"编辑条目":"新建条目"),1),(0,n.Lk)("h2",null,(0,a.v_)(Y.title||"未命名词条"),1),O.value||H.value?((0,n.uX)(),(0,n.CE)("div",y,["saving"===H.value?((0,n.uX)(),(0,n.Wv)(l,{key:0},{default:(0,n.k6)(()=>[(0,n.bF)((0,s.R1)(k.Loading))]),_:1})):"saved"===H.value?((0,n.uX)(),(0,n.Wv)(l,{key:1},{default:(0,n.k6)(()=>[(0,n.bF)((0,s.R1)(k.CircleCheck))]),_:1})):(0,n.Q3)("",!0),(0,n.Lk)("span",b,(0,a.v_)("saving"===H.value?"正在保存...":"saved"===H.value?"已自动保存":"有未保存的更改"),1)])):(0,n.Q3)("",!0)]),(0,n.Lk)("div",w,[(0,n.bF)(r,{onClick:he},{default:(0,n.k6)(()=>[...t[15]||(t[15]=[(0,n.eW)("返回列表",-1)])]),_:1}),(0,n.bF)(r,{type:"primary",loading:u.value,onClick:ge},{default:(0,n.k6)(()=>[(0,n.eW)((0,a.v_)(le.value?"提交更新":"发布词条"),1)]),_:1},8,["loading"])])])]),default:(0,n.k6)(()=>[(0,n.bF)(v,{model:Y,"label-width":"80px",class:"editor-form"},{default:(0,n.k6)(()=>[(0,n.bF)(c,{label:"标题"},{default:(0,n.k6)(()=>[(0,n.bF)(o,{modelValue:Y.title,"onUpdate:modelValue":t[0]||(t[0]=e=>Y.title=e),placeholder:"请输入标题",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),(0,n.bF)(c,{label:"摘要"},{default:(0,n.k6)(()=>[(0,n.bF)(o,{modelValue:Y.summary,"onUpdate:modelValue":t[1]||(t[1]=e=>Y.summary=e),type:"textarea",rows:2,maxlength:"500","show-word-limit":"",placeholder:"简要概述条目"},null,8,["modelValue"])]),_:1}),(0,n.bF)(c,{label:"正文"},{default:(0,n.k6)(()=>[(0,n.Lk)("div",_,[(0,n.Lk)("div",C,[(0,n.Lk)("div",$,[(0,n.Lk)("div",L,[(0,n.bF)(d,null,{default:(0,n.k6)(()=>[(0,n.bF)(r,{size:"small",onClick:t[2]||(t[2]=e=>ne("**","**","加粗")),title:"加粗 (Ctrl+B)"},{default:(0,n.k6)(()=>[...t[16]||(t[16]=[(0,n.Lk)("strong",null,"B",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:t[3]||(t[3]=e=>ne("*","*","斜体")),title:"斜体 (Ctrl+I)"},{default:(0,n.k6)(()=>[...t[17]||(t[17]=[(0,n.Lk)("em",null,"I",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:t[4]||(t[4]=e=>ne("`","`","行内代码")),title:"行内代码"},{default:(0,n.k6)(()=>[...t[18]||(t[18]=[(0,n.eW)(" </> ",-1)])]),_:1})]),_:1})]),(0,n.Lk)("div",F,[(0,n.bF)(d,null,{default:(0,n.k6)(()=>[(0,n.bF)(r,{size:"small",onClick:t[5]||(t[5]=e=>ne("# ","","一级标题")),title:"一级标题"},{default:(0,n.k6)(()=>[...t[19]||(t[19]=[(0,n.eW)(" H1 ",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:t[6]||(t[6]=e=>ne("## ","","二级标题")),title:"二级标题"},{default:(0,n.k6)(()=>[...t[20]||(t[20]=[(0,n.eW)(" H2 ",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:t[7]||(t[7]=e=>ne("### ","","三级标题")),title:"三级标题"},{default:(0,n.k6)(()=>[...t[21]||(t[21]=[(0,n.eW)(" H3 ",-1)])]),_:1})]),_:1})]),(0,n.Lk)("div",S,[(0,n.bF)(d,null,{default:(0,n.k6)(()=>[(0,n.bF)(r,{size:"small",onClick:t[8]||(t[8]=e=>ne("- ","","无序列表")),title:"无序列表"},{default:(0,n.k6)(()=>[...t[22]||(t[22]=[(0,n.eW)(" • ",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:t[9]||(t[9]=e=>ne("1. ","","有序列表")),title:"有序列表"},{default:(0,n.k6)(()=>[...t[23]||(t[23]=[(0,n.eW)(" 1. ",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:t[10]||(t[10]=e=>ne("> ","","引用")),title:"引用"},{default:(0,n.k6)(()=>[...t[24]||(t[24]=[(0,n.eW)(' " ',-1)])]),_:1})]),_:1})]),(0,n.Lk)("div",x,[(0,n.bF)(r,{size:"small",onClick:ae,title:"代码块"},{default:(0,n.k6)(()=>[...t[25]||(t[25]=[(0,n.eW)(" { } ",-1)])]),_:1}),(0,n.bF)(r,{size:"small",onClick:se,title:"插入链接"},{default:(0,n.k6)(()=>[...t[26]||(t[26]=[(0,n.eW)(" 链接 ",-1)])]),_:1}),(0,n.bF)(m,{class:"upload-btn",action:"/api/files/upload?category=WIKI","show-file-list":!1,"before-upload":oe,"on-success":ue,"on-error":ce},{default:(0,n.k6)(()=>[(0,n.bF)(r,{size:"small",loading:M.value},{default:(0,n.k6)(()=>[(0,n.eW)((0,a.v_)(M.value?"上传中...":"图片"),1)]),_:1},8,["loading"])]),_:1})])]),(0,n.Lk)("div",W,[(0,n.bF)(o,{ref_key:"contentInputRef",ref:q,modelValue:Y.content,"onUpdate:modelValue":t[11]||(t[11]=e=>Y.content=e),type:"textarea",rows:18,class:"markdown-input",placeholder:"支持 Markdown 语法，使用工具栏快捷按钮或直接输入 Markdown 语法",onKeydown:[t[12]||(t[12]=(0,i.jR)((0,i.D$)(e=>ne("**","**","加粗"),["ctrl","prevent"]),["b"])),t[13]||(t[13]=(0,i.jR)((0,i.D$)(e=>ne("*","*","斜体"),["ctrl","prevent"]),["i"]))]},null,8,["modelValue"]),(0,n.Lk)("div",E,[(0,n.Lk)("span",null,"字数: "+(0,a.v_)(te.value.words),1),(0,n.Lk)("span",null,"字符: "+(0,a.v_)(te.value.chars),1),(0,n.Lk)("span",null,"行数: "+(0,a.v_)(te.value.lines),1)])]),Q.value.length?((0,n.uX)(),(0,n.CE)("div",R,[t[28]||(t[28]=(0,n.Lk)("p",{class:"images-title"},"已上传图片",-1)),(0,n.Lk)("div",z,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(Q.value,e=>((0,n.uX)(),(0,n.CE)("div",{key:e.uid,class:"image-thumb"},[(0,n.Lk)("img",{src:e.url,alt:e.url},null,8,A),(0,n.bF)(r,{text:"",type:"danger",size:"small",onClick:t=>de(e)},{default:(0,n.k6)(()=>[...t[27]||(t[27]=[(0,n.eW)(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128))])])):(0,n.Q3)("",!0)]),(0,n.Lk)("div",T,[(0,n.Lk)("div",V,[t[29]||(t[29]=(0,n.Lk)("span",null,"实时预览",-1)),ee.value.length>0?((0,n.uX)(),(0,n.Wv)(r,{key:0,text:"",size:"small",onClick:re},{default:(0,n.k6)(()=>[(0,n.eW)((0,a.v_)(D.value?"隐藏目录":"显示目录"),1)]),_:1})):(0,n.Q3)("",!0)]),(0,n.Lk)("div",K,[D.value&&ee.value.length>0?((0,n.uX)(),(0,n.CE)("div",I,[t[30]||(t[30]=(0,n.Lk)("h4",null,"目录",-1)),(0,n.Lk)("ul",null,[((0,n.uX)(!0),(0,n.CE)(n.FK,null,(0,n.pI)(ee.value,(e,t)=>((0,n.uX)(),(0,n.CE)("li",{key:t,class:(0,a.C4)(`toc-level-${e.level}`),onClick:t=>ie(e.text)},(0,a.v_)(e.text),11,X))),128))])])):(0,n.Q3)("",!0),(0,n.Lk)("div",{class:"preview-content",ref_key:"previewContentRef",ref:j,innerHTML:P.value},null,8,B)])])])]),_:1}),le.value?((0,n.uX)(),(0,n.Wv)(c,{key:0,label:"编辑说明"},{default:(0,n.k6)(()=>[(0,n.bF)(o,{modelValue:Y.editSummary,"onUpdate:modelValue":t[14]||(t[14]=e=>Y.editSummary=e),type:"textarea",rows:2,maxlength:"200","show-word-limit":"",placeholder:"简要说明本次编辑的变更内容（可选）"},null,8,["modelValue"])]),_:1})):(0,n.Q3)("",!0)]),_:1},8,["model"])]),_:1})])}}},Q=l(6262);const q=(0,Q.A)(M,[["__scopeId","data-v-8bc21522"]]);var j=q}}]);
//# sourceMappingURL=660.a3173fd6.js.map