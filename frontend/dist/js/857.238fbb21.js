"use strict";(self["webpackChunkChunyin"]=self["webpackChunkChunyin"]||[]).push([[857],{5857:function(e,a,t){t.r(a),t.d(a,{default:function(){return I}});t(4114);var l=t(641),s=t(953),n=t(33),o=t(5220),u=t(163),i=t(8548),r=t(4402),c=t(6901),d=t(6617),v=t(3945),m=t(5467);const p={class:"nearby-container"},g={class:"city-selector"},k={class:"content-wrapper"},y={class:"posts-section"},b={key:0,class:"loading"},f={key:1,class:"empty"},h={key:2,class:"masonry-grid"},C={key:3,class:"load-more"},F={key:4,class:"no-more"},E={class:"recommendation-section"},_={class:"bars-list"},w={key:0,class:"empty-bars"},L=["onClick"],R={class:"bar-info"},X={class:"bar-name"},A={class:"bar-rating"},K={class:"review-count"},$={class:"bar-address"},N={key:0,class:"bar-distance"},U={key:1,class:"show-more"};var W={__name:"Nearby",setup(e){const a=(0,o.rd)(),t=(0,s.KR)(""),W=(0,s.KR)([]),V=(0,s.KR)(!1),S=(0,s.KR)(1),I=(0,s.KR)(12),Q=(0,s.KR)(!0),D=(0,s.KR)([]),P=(0,s.KR)(!1),x=(0,s.KR)(null),{provinces:B,loading:O,ensureLoaded:z,findCityByName:M,getDefaultCity:Y}=(0,v.m)(),{detecting:G,detectCity:T}=(0,m.K)(),H=async(e=0)=>{if(t.value){V.value=!0;try{const e=await r.x.listPostsByCity(t.value,S.value,I.value),a=e.data;1===S.value?W.value=a.items||[]:W.value.push(...a.items||[]),Q.value=(a.items||[]).length>=I.value}catch(a){const t="ECONNREFUSED"===a.code||a.message?.includes("ECONNREFUSED")||a.message?.includes("Network Error")||void 0===a.response;if(t&&e<3)return await new Promise(a=>setTimeout(a,1e3*(e+1))),H(e+1);t||console.error("Failed to load nearby posts:",a)}finally{V.value=!1}}},j=()=>{t.value&&(S.value=1,W.value=[],Q.value=!0,H())},q=()=>{S.value++,H()},J=e=>{a.push(`/posts/${e}`)},Z=async()=>{await z();const e=await T(),a=e?M(e):null;t.value=a?.city||Y()||"北京市",j()},ee=async()=>{await z();const e=await T();if(!e)return void u.nk.warning("无法定位，请手动选择城市");const a=M(e);a?.city?(t.value=a.city,u.nk.success(`已定位到 ${a.city}`),j()):u.nk.warning("未找到匹配的城市，请手动选择")},ae=()=>navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(a=>{const t={latitude:a.coords.latitude,longitude:a.coords.longitude};x.value=t,e(t)},()=>{e(null)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}):Promise.resolve(null),te=async(e=0)=>{if(x.value){P.value=!0;try{const{data:e}=await(0,c.K6)({latitude:x.value.latitude,longitude:x.value.longitude,limit:5});D.value=e||[]}catch(a){const t="ECONNREFUSED"===a.code||a.message?.includes("ECONNREFUSED")||a.message?.includes("Network Error")||void 0===a.response;if(t&&e<3)return await new Promise(a=>setTimeout(a,1e3*(e+1))),te(e+1);t||console.error("Failed to load recommended bars:",a)}finally{P.value=!1}}},le=e=>{a.push(`/bars/${e}`)},se=()=>{a.push("/bars")};return(0,l.sV)(async()=>{await Z(),setTimeout(async()=>{await ae(),x.value&&te()},500)}),(e,a)=>{const o=(0,l.g2)("el-option"),u=(0,l.g2)("el-option-group"),r=(0,l.g2)("el-select"),c=(0,l.g2)("el-button"),v=(0,l.g2)("el-empty"),m=(0,l.g2)("el-rate"),S=(0,l.g2)("el-icon"),I=(0,l.g2)("el-card"),x=(0,l.gN)("loading");return(0,l.uX)(),(0,l.CE)("div",p,[(0,l.Lk)("div",g,[a[1]||(a[1]=(0,l.Lk)("label",null,"选择城市:",-1)),(0,l.bF)(r,{modelValue:t.value,"onUpdate:modelValue":a[0]||(a[0]=e=>t.value=e),filterable:"",clearable:"",loading:(0,s.R1)(O),placeholder:"选择城市",onChange:j},{default:(0,l.k6)(()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)((0,s.R1)(B),e=>((0,l.uX)(),(0,l.Wv)(u,{key:e.value,label:e.label},{default:(0,l.k6)(()=>[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(e.cities,e=>((0,l.uX)(),(0,l.Wv)(o,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","loading"]),(0,l.bF)(c,{text:"",size:"small",class:"locate-btn",loading:(0,s.R1)(G),onClick:ee},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)((0,s.R1)(G)?"定位中…":"自动定位"),1)]),_:1},8,["loading"])]),(0,l.Lk)("div",k,[(0,l.Lk)("div",y,[V.value&&0===W.value.length?((0,l.uX)(),(0,l.CE)("div",b,"加载中...")):0===W.value.length?((0,l.uX)(),(0,l.CE)("div",f,[(0,l.bF)(v,{description:`${t.value}还没有动态`},null,8,["description"])])):((0,l.uX)(),(0,l.CE)("div",h,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(W.value,e=>((0,l.uX)(),(0,l.Wv)(d.A,{key:e.id,post:e,onSelect:a=>J(e.id)},null,8,["post","onSelect"]))),128))])),!V.value&&Q.value?((0,l.uX)(),(0,l.CE)("div",C,[(0,l.bF)(c,{onClick:q},{default:(0,l.k6)(()=>[...a[2]||(a[2]=[(0,l.eW)("加载更多",-1)])]),_:1})])):(0,l.Q3)("",!0),!Q.value&&W.value.length>0?((0,l.uX)(),(0,l.CE)("div",F," 已加载全部内容 ")):(0,l.Q3)("",!0)]),(0,l.Lk)("div",E,[(0,l.bF)(I,{class:"recommendation-card"},{header:(0,l.k6)(()=>[...a[3]||(a[3]=[(0,l.Lk)("div",{class:"card-header"},[(0,l.Lk)("span",{class:"card-title"},"酒吧推荐")],-1)])]),default:(0,l.k6)(()=>[(0,l.bo)(((0,l.uX)(),(0,l.CE)("div",_,[0!==D.value.length||P.value?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",w,[(0,l.bF)(v,{description:"暂无推荐酒吧","image-size":80})])),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(D.value,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:"bar-item",onClick:a=>le(e.id)},[(0,l.Lk)("div",R,[(0,l.Lk)("h3",X,(0,n.v_)(e.name),1),(0,l.Lk)("div",A,[(0,l.bF)(m,{modelValue:e.avgRating,"onUpdate:modelValue":a=>e.avgRating=a,disabled:"","show-score":"",colors:["#99A9BF","#F7BA2A","#FF9900"]},null,8,["modelValue","onUpdate:modelValue"]),(0,l.Lk)("span",K,"("+(0,n.v_)(e.reviewCount||0)+"条评价)",1)]),(0,l.Lk)("p",$,[(0,l.bF)(S,null,{default:(0,l.k6)(()=>[(0,l.bF)((0,s.R1)(i.LocationFilled))]),_:1}),(0,l.eW)(" "+(0,n.v_)(e.address),1)]),e.distance?((0,l.uX)(),(0,l.CE)("p",N," 距离: "+(0,n.v_)(e.distance.toFixed(2))+" 公里 ",1)):(0,l.Q3)("",!0)])],8,L))),128)),D.value.length>0?((0,l.uX)(),(0,l.CE)("div",U,[(0,l.bF)(c,{type:"primary",plain:"",onClick:se},{default:(0,l.k6)(()=>[...a[4]||(a[4]=[(0,l.eW)("显示更多",-1)])]),_:1})])):(0,l.Q3)("",!0)])),[[x,P.value]])]),_:1})])])])}}},V=t(6262);const S=(0,V.A)(W,[["__scopeId","data-v-4a76eac6"]]);var I=S},6617:function(e,a,t){t.d(a,{A:function(){return U}});var l=t(641),s=t(33),n=t(953),o=t(4353),u=t.n(o),i=t(8660),r=t.n(i),c=t(8548);const d={key:0,class:"recommend-badge"},v={key:1,class:"card-media"},m=["src","alt"],p={class:"image-overlay"},g={class:"overlay-item"},k={class:"overlay-item"},y={key:0,class:"count"},b={key:2,class:"card-media no-image"},f={class:"no-image-text"},h={class:"image-overlay"},C={class:"overlay-item"},F={class:"overlay-item"},E={class:"card-body"},_={class:"content"},w={key:0,class:"tags"},L={class:"card-meta"},R={class:"author"},X={class:"name"},A={class:"time"};var K={__name:"PostCard",props:{post:{type:Object,required:!0},layout:{type:String,default:"masonry"}},emits:["select"],setup(e){u().extend(r());const a=e=>e?e.length>29?`${e.slice(0,29)}...`:e:"",t=e=>e?e.length>60?`${e.slice(0,60)}...`:e:"分享此刻的灵感",o=e=>{if(!e)return"";const a=u()(e),t=u()(),l=t.diff(a,"minute");if(l<60)return`${l||1}分钟前`;const s=t.diff(a,"hour");return s<24?`${s}小时前`:a.isSame(t,"year")?a.format("M月D日"):a.format("YYYY年M月D日")};return(u,i)=>{const r=(0,l.g2)("el-icon"),K=(0,l.g2)("el-tag"),$=(0,l.g2)("el-avatar");return(0,l.uX)(),(0,l.CE)("div",{class:(0,s.C4)(["post-card",e.layout,{"is-recommended":e.post.isRecommended}]),onClick:i[0]||(i[0]=a=>u.$emit("select",e.post))},[e.post.isRecommended?((0,l.uX)(),(0,l.CE)("div",d,[(0,l.bF)(r,null,{default:(0,l.k6)(()=>[(0,l.bF)((0,n.R1)(c.MagicStick))]),_:1}),i[1]||(i[1]=(0,l.Lk)("span",null,"猜你喜欢",-1))])):(0,l.Q3)("",!0),e.post.imageUrls?.length?((0,l.uX)(),(0,l.CE)("div",v,[(0,l.Lk)("img",{src:e.post.imageUrls[0],alt:e.post.content||`${e.post.author?.username||"用户"}的分享图片`},null,8,m),(0,l.Lk)("div",p,[(0,l.Lk)("span",g,[(0,l.bF)(r,null,{default:(0,l.k6)(()=>[(0,l.bF)((0,n.R1)(c.View))]),_:1}),(0,l.eW)((0,s.v_)(e.post.viewCount||0),1)]),(0,l.Lk)("span",k,[(0,l.bF)(r,null,{default:(0,l.k6)(()=>[(0,l.bF)((0,n.R1)(c.GobletFull))]),_:1}),(0,l.eW)((0,s.v_)(e.post.likeCount||0),1)])]),e.post.imageUrls.length>1?((0,l.uX)(),(0,l.CE)("span",y,"+"+(0,s.v_)(e.post.imageUrls.length-1),1)):(0,l.Q3)("",!0)])):((0,l.uX)(),(0,l.CE)("div",b,[(0,l.Lk)("p",f,(0,s.v_)(t(e.post.content)),1),(0,l.Lk)("div",h,[(0,l.Lk)("span",C,[(0,l.bF)(r,null,{default:(0,l.k6)(()=>[(0,l.bF)((0,n.R1)(c.View))]),_:1}),(0,l.eW)((0,s.v_)(e.post.viewCount||0),1)]),(0,l.Lk)("span",F,[(0,l.bF)(r,null,{default:(0,l.k6)(()=>[(0,l.bF)((0,n.R1)(c.GobletFull))]),_:1}),(0,l.eW)((0,s.v_)(e.post.likeCount||0),1)])])])),(0,l.Lk)("div",E,[(0,l.Lk)("p",_,(0,s.v_)(a(e.post.content)),1),e.post.tags?.length?((0,l.uX)(),(0,l.CE)("div",w,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(e.post.tags.slice(0,2),e=>((0,l.uX)(),(0,l.Wv)(K,{key:e,size:"small",effect:"light"},{default:(0,l.k6)(()=>[(0,l.eW)(" # "+(0,s.v_)(e),1)]),_:2},1024))),128))])):(0,l.Q3)("",!0)]),(0,l.Lk)("div",L,[(0,l.Lk)("div",R,[(0,l.bF)($,{src:e.post.author?.avatarUrl,size:28,alt:`${e.post.author?.username||"用户"}的头像`},null,8,["src","alt"]),(0,l.Lk)("p",X,(0,s.v_)(e.post.author?.username),1)]),(0,l.Lk)("span",A,(0,s.v_)(o(e.post.createdAt)),1)])],2)}}},$=t(6262);const N=(0,$.A)(K,[["__scopeId","data-v-2be613fd"]]);var U=N},6901:function(e,a,t){t.d(a,{BG:function(){return n},Bk:function(){return u},FC:function(){return d},HK:function(){return v},K6:function(){return m},KJ:function(){return r},N$:function(){return p},lU:function(){return s},pM:function(){return i},v7:function(){return c},w9:function(){return o}});var l=t(7277);const s=e=>(0,l.A)({url:"/bars/register",method:"post",data:e}),n=e=>(0,l.A)({url:`/bars/${e}`,method:"get"}),o=e=>(0,l.A)({url:"/bars/nearby",method:"get",params:e}),u=e=>(0,l.A)({url:`/bars/city/${e}`,method:"get"}),i=e=>(0,l.A)({url:"/bars/search",method:"get",params:e}),r=()=>(0,l.A)({url:"/bars/applications/my",method:"get"}),c=e=>(0,l.A)({url:"/bars/reviews",method:"post",data:e}),d=e=>(0,l.A)({url:`/bars/${e}/reviews`,method:"get"}),v=e=>(0,l.A)({url:`/bars/reviews/${e}`,method:"delete"}),m=e=>(0,l.A)({url:"/bars/recommend",method:"get",params:e}),p=e=>{const a={};return e&&Array.isArray(e)&&e.length>0&&(a.alcoholIds=e),(0,l.A)({url:"/bars/my",method:"get",params:a})}}}]);
//# sourceMappingURL=857.238fbb21.js.map