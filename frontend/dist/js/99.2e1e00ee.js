"use strict";(self["webpackChunkChunyin"]=self["webpackChunkChunyin"]||[]).push([[99],{6480:function(e,a,t){t.r(a),t.d(a,{default:function(){return _}});t(4114);var i=t(641),s=t(33),n=t(3751);const r={class:"bar-list"},o={class:"page-header"},l={class:"search-form"},c={class:"search-form"},d={class:"search-form"},u={class:"bar-grid"},h={class:"bar-info"},p={class:"bar-name"},m={class:"bar-rating"},g={class:"review-count"},b={class:"bar-address"},y={key:0,class:"bar-distance"},k={key:1,class:"bar-beverages"},f={key:2,class:"bar-time"};function M(e,a,t,M,v,w){const C=(0,i.g2)("el-button"),A=(0,i.g2)("el-input-number"),L=(0,i.g2)("el-form-item"),F=(0,i.g2)("Location"),_=(0,i.g2)("el-icon"),T=(0,i.g2)("el-form"),I=(0,i.g2)("el-text"),x=(0,i.g2)("el-tab-pane"),B=(0,i.g2)("el-input"),N=(0,i.g2)("el-tabs"),$=(0,i.g2)("el-card"),E=(0,i.g2)("el-empty"),S=(0,i.g2)("el-rate"),V=(0,i.g2)("LocationFilled"),W=(0,i.g2)("Clock"),U=(0,i.gN)("loading");return(0,i.uX)(),(0,i.CE)("div",r,[(0,i.Lk)("div",o,[a[6]||(a[6]=(0,i.Lk)("h2",null,"附近酒吧",-1)),(0,i.bF)(C,{type:"primary",onClick:a[0]||(a[0]=a=>e.$router.push("/bars/register"))},{default:(0,i.k6)(()=>[...a[5]||(a[5]=[(0,i.eW)(" 注册酒吧 ",-1)])]),_:1})]),(0,i.bF)($,{class:"search-card"},{default:(0,i.k6)(()=>[(0,i.bF)(N,{modelValue:v.searchType,"onUpdate:modelValue":a[4]||(a[4]=e=>v.searchType=e),onTabChange:w.handleTabChange},{default:(0,i.k6)(()=>[(0,i.bF)(x,{label:"附近搜索",name:"nearby"},{default:(0,i.k6)(()=>[(0,i.Lk)("div",l,[(0,i.bF)(T,{inline:!0},{default:(0,i.k6)(()=>[(0,i.bF)(L,{label:"搜索半径"},{default:(0,i.k6)(()=>[(0,i.bF)(A,{modelValue:v.searchRadius,"onUpdate:modelValue":a[1]||(a[1]=e=>v.searchRadius=e),min:1,max:100,step:5,style:{width:"150px"}},null,8,["modelValue"]),a[7]||(a[7]=(0,i.Lk)("span",{style:{"margin-left":"8px"}},"公里",-1))]),_:1}),(0,i.bF)(L,null,{default:(0,i.k6)(()=>[(0,i.bF)(C,{type:"primary",onClick:w.searchNearby,loading:v.loading},{default:(0,i.k6)(()=>[...a[8]||(a[8]=[(0,i.eW)(" 搜索附近 ",-1)])]),_:1},8,["onClick","loading"]),(0,i.bF)(C,{onClick:w.getCurrentLocation,loading:v.locating},{default:(0,i.k6)(()=>[(0,i.bF)(_,null,{default:(0,i.k6)(()=>[(0,i.bF)(F)]),_:1}),a[9]||(a[9]=(0,i.eW)(" 获取当前位置 ",-1))]),_:1},8,["onClick","loading"])]),_:1})]),_:1}),v.userLocation?((0,i.uX)(),(0,i.Wv)(I,{key:0,type:"success",size:"small"},{default:(0,i.k6)(()=>[(0,i.eW)(" 当前位置：经度 "+(0,s.v_)(v.userLocation.longitude.toFixed(6))+"，纬度 "+(0,s.v_)(v.userLocation.latitude.toFixed(6)),1)]),_:1})):((0,i.uX)(),(0,i.Wv)(I,{key:1,type:"info",size:"small"},{default:(0,i.k6)(()=>[...a[10]||(a[10]=[(0,i.eW)(' 点击"获取当前位置"按钮获取您的地理位置，然后点击"搜索附近"查找周边酒吧 ',-1)])]),_:1}))])]),_:1}),(0,i.bF)(x,{label:"按城市搜索",name:"city"},{default:(0,i.k6)(()=>[(0,i.Lk)("div",c,[(0,i.bF)(T,{inline:!0},{default:(0,i.k6)(()=>[(0,i.bF)(L,{label:"城市名称"},{default:(0,i.k6)(()=>[(0,i.bF)(B,{modelValue:v.searchCity,"onUpdate:modelValue":a[2]||(a[2]=e=>v.searchCity=e),placeholder:"支持模糊搜索，如：上海、北京",style:{width:"250px"},clearable:"",onKeyup:(0,n.jR)(w.searchByCity,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),(0,i.bF)(L,null,{default:(0,i.k6)(()=>[(0,i.bF)(C,{type:"primary",onClick:w.searchByCity,loading:v.loading},{default:(0,i.k6)(()=>[...a[11]||(a[11]=[(0,i.eW)(" 搜索 ",-1)])]),_:1},8,["onClick","loading"])]),_:1})]),_:1})])]),_:1}),(0,i.bF)(x,{label:"综合搜索",name:"name"},{default:(0,i.k6)(()=>[(0,i.Lk)("div",d,[(0,i.bF)(T,{inline:!0},{default:(0,i.k6)(()=>[(0,i.bF)(L,{label:"关键词"},{default:(0,i.k6)(()=>[(0,i.bF)(B,{modelValue:v.searchName,"onUpdate:modelValue":a[3]||(a[3]=e=>v.searchName=e),placeholder:"搜索名称/城市/地址/酒类",style:{width:"250px"},clearable:"",onKeyup:(0,n.jR)(w.searchByName,["enter"])},null,8,["modelValue","onKeyup"])]),_:1}),(0,i.bF)(L,null,{default:(0,i.k6)(()=>[(0,i.bF)(C,{type:"primary",onClick:w.searchByName,loading:v.loading},{default:(0,i.k6)(()=>[...a[12]||(a[12]=[(0,i.eW)(" 搜索 ",-1)])]),_:1},8,["onClick","loading"])]),_:1})]),_:1}),(0,i.bF)(I,{type:"info",size:"small"},{default:(0,i.k6)(()=>[...a[13]||(a[13]=[(0,i.eW)(" 可搜索酒吧名称、城市、地址或主营酒类，如：鸡尾酒、威士忌、黄浦区等 ",-1)])]),_:1})])]),_:1})]),_:1},8,["modelValue","onTabChange"])]),_:1}),(0,i.bF)($,{class:"map-card"},{header:(0,i.k6)(()=>[...a[14]||(a[14]=[(0,i.Lk)("span",null,"地图",-1)])]),default:(0,i.k6)(()=>[a[15]||(a[15]=(0,i.Lk)("div",{id:"amap-container",class:"amap-container"},null,-1))]),_:1}),(0,i.bo)(((0,i.uX)(),(0,i.CE)("div",u,[0!==v.bars.length||v.loading?(0,i.Q3)("",!0):((0,i.uX)(),(0,i.Wv)(E,{key:0,description:"暂无酒吧信息"})),((0,i.uX)(!0),(0,i.CE)(i.FK,null,(0,i.pI)(v.bars,e=>((0,i.uX)(),(0,i.Wv)($,{key:e.id,class:"bar-card",shadow:"hover",onClick:a=>w.goToDetail(e.id)},{default:(0,i.k6)(()=>[(0,i.Lk)("div",h,[(0,i.Lk)("h3",p,(0,s.v_)(e.name),1),(0,i.Lk)("div",m,[(0,i.bF)(S,{modelValue:e.avgRating,"onUpdate:modelValue":a=>e.avgRating=a,disabled:"","show-score":"",colors:["#99A9BF","#F7BA2A","#FF9900"]},null,8,["modelValue","onUpdate:modelValue"]),(0,i.Lk)("span",g,"("+(0,s.v_)(e.reviewCount)+"条评价)",1)]),(0,i.Lk)("p",b,[(0,i.bF)(_,null,{default:(0,i.k6)(()=>[(0,i.bF)(V)]),_:1}),(0,i.eW)(" "+(0,s.v_)(e.address),1)]),e.distance?((0,i.uX)(),(0,i.CE)("p",y," 距离: "+(0,s.v_)(e.distance.toFixed(2))+" 公里 ",1)):(0,i.Q3)("",!0),e.mainBeverages?((0,i.uX)(),(0,i.CE)("p",k," 主营: "+(0,s.v_)(e.mainBeverages),1)):(0,i.Q3)("",!0),e.openingTime&&e.closingTime?((0,i.uX)(),(0,i.CE)("div",f,[(0,i.bF)(_,null,{default:(0,i.k6)(()=>[(0,i.bF)(W)]),_:1}),(0,i.eW)(" "+(0,s.v_)(w.formatTime(e.openingTime))+" - "+(0,s.v_)(w.formatTime(e.closingTime)),1)])):(0,i.Q3)("",!0)])]),_:2},1032,["onClick"]))),128))])),[[U,v.loading]])])}t(8111),t(7588),t(1701),t(3110);var v=t(6901),w=t(8548),C=t(163),A={name:"BarList",components:{LocationFilled:w.LocationFilled,Clock:w.Clock,Location:w.Location},data(){return{searchType:"nearby",searchCity:"",searchName:"",searchRadius:10,userLocation:null,bars:[],loading:!1,locating:!1,map:null,markers:[],userMarker:null,amapKey:"f0a59cbd6ac9131a3b2d338932a82bca"}},mounted(){this.getCurrentLocation(),this.$nextTick(()=>{setTimeout(()=>{this.loadAmapScript()},300)})},beforeUnmount(){if(this.map){try{this.map.destroy()}catch(e){}this.map=null}if(this.userMarker){try{this.userMarker.setMap(null)}catch(e){}this.userMarker=null}this.markers.forEach(a=>{try{a.setMap(null)}catch(e){}}),this.markers=[]},methods:{handleTabChange(){},getCurrentLocation(){navigator.geolocation?(this.locating=!0,navigator.geolocation.getCurrentPosition(e=>{if(this.userLocation={latitude:e.coords.latitude,longitude:e.coords.longitude},this.locating=!1,C.nk.success("位置获取成功"),this.map){const e=[this.userLocation.longitude,this.userLocation.latitude];this.map.setCenter(e),this.map.setZoom(13),this.addUserMarker(e)}},e=>{this.locating=!1;let a="获取位置失败";switch(e.code){case e.PERMISSION_DENIED:a="您拒绝了位置权限请求";break;case e.POSITION_UNAVAILABLE:a="位置信息不可用";break;case e.TIMEOUT:a="获取位置超时";break}C.nk.error(a)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})):C.nk.error("您的浏览器不支持地理定位功能")},async searchNearby(){if(this.userLocation){fetch("http://127.0.0.1:7242/ingest/2be73884-0cc8-4c48-bb93-e298599f041c",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"BarList.vue:searchNearby",message:"search nearby called",data:{lat:this.userLocation.latitude,lng:this.userLocation.longitude,radius:this.searchRadius},timestamp:Date.now(),sessionId:"debug-session",runId:"nearby-frontend",hypothesisId:"I"})}).catch(()=>{}),this.loading=!0;try{const{data:e}=await(0,v.w9)({latitude:this.userLocation.latitude,longitude:this.userLocation.longitude,radiusKm:this.searchRadius});fetch("http://127.0.0.1:7242/ingest/2be73884-0cc8-4c48-bb93-e298599f041c",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"BarList.vue:searchNearby:result",message:"search result",data:{count:e?e.length:0,isArray:Array.isArray(e)},timestamp:Date.now(),sessionId:"debug-session",runId:"nearby-frontend",hypothesisId:"J"})}).catch(()=>{}),this.bars=e||[],0===this.bars.length?C.nk.info(`附近${this.searchRadius}公里内没有找到酒吧`):(C.nk.success(`找到${this.bars.length}家附近的酒吧`),this.$nextTick(()=>{this.updateMapMarkers()}))}catch(e){fetch("http://127.0.0.1:7242/ingest/2be73884-0cc8-4c48-bb93-e298599f041c",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:"BarList.vue:searchNearby:error",message:"search error",data:{errorMsg:e.message,errorType:e.constructor.name},timestamp:Date.now(),sessionId:"debug-session",runId:"nearby-frontend",hypothesisId:"K"})}).catch(()=>{}),C.nk.error(e.message||"搜索失败")}finally{this.loading=!1}}else C.nk.warning("请先获取当前位置")},async searchByCity(){if(this.searchCity.trim()){this.loading=!0;try{const{data:e}=await(0,v.Bk)(this.searchCity);this.bars=e||[],this.$nextTick(()=>{this.updateMapMarkers()})}catch(e){C.nk.error(e.message||"搜索失败")}finally{this.loading=!1}}else C.nk.warning("请输入城市名称")},async searchByName(){if(this.searchName.trim()){this.loading=!0;try{const{data:e}=await(0,v.pM)({name:this.searchName});this.bars=e||[],this.$nextTick(()=>{this.updateMapMarkers()})}catch(e){C.nk.error(e.message||"搜索失败")}finally{this.loading=!1}}else C.nk.warning("请输入搜索关键词")},goToDetail(e){this.$router.push(`/bars/${e}`)},formatTime(e){return e?e.substring(0,5):""},loadAmapScript(){const e=document.getElementById("amap-container");if(!e)return void setTimeout(()=>this.loadAmapScript(),100);if(window.AMap&&window.AMap.Map)return void setTimeout(()=>{this.initMap()},100);if(document.querySelector('script[src*="webapi.amap.com"]')){const e=setInterval(()=>{window.AMap&&window.AMap.Map&&(clearInterval(e),setTimeout(()=>{this.initMap()},100))},100);return void setTimeout(()=>{clearInterval(e)},1e4)}const a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=`https://webapi.amap.com/maps?v=2.0&key=${this.amapKey}&plugin=AMap.Geolocation,AMap.Marker,AMap.CitySearch`,a.onload=()=>{setTimeout(()=>{window.AMap&&window.AMap.Map?this.initMap():C.nk.error("高德地图API加载失败")},300)},a.onerror=()=>{C.nk.error("高德地图脚本加载失败，请检查网络连接或key配置")},document.head.appendChild(a)},initMap(){if(!window.AMap||!window.AMap.Map)return;const e=document.getElementById("amap-container");if(!e)return;if(e.style.height="500px",e.style.width="100%",e.style.display="block",e.style.visibility="visible",this.map){try{this.map.destroy()}catch(i){}this.map=null}let a=[116.397428,39.90923],t=11;this.userLocation&&this.userLocation.longitude&&this.userLocation.latitude&&(a=[this.userLocation.longitude,this.userLocation.latitude],t=13);try{this.map=new AMap.Map("amap-container",{viewMode:"2D",zoom:t,center:a}),this.map.on("complete",()=>{if(this.userLocation&&this.userLocation.longitude&&this.userLocation.latitude){const e=[this.userLocation.longitude,this.userLocation.latitude];this.map.setCenter(e),this.map.setZoom(13),this.addUserMarker(e)}else this.updateMapCenterByIP();this.bars.length>0&&this.updateMapMarkers()})}catch(s){C.nk.error("地图初始化失败："+(s.message||"未知错误"))}},updateMapCenterByIP(){window.AMap&&this.map&&(this.userLocation&&this.userLocation.longitude&&this.userLocation.latitude||AMap.plugin("AMap.CitySearch",()=>{const e=new AMap.CitySearch;e.getLocalCity((e,a)=>{if("complete"===e&&a.bounds){const e=a.bounds.getCenter();this.map.setCenter([e.lng,e.lat]),this.map.setZoom(13),this.addUserMarker([e.lng,e.lat])}})}))},addUserMarker(e){if(this.map&&e){if(this.userMarker)try{this.userMarker.setMap(null)}catch(a){}try{this.userMarker=new AMap.Marker({position:e,title:"我的位置",icon:new AMap.Icon({size:new AMap.Size(32,32),image:"https://webapi.amap.com/theme/v1.3/markers/n/mid.png"})}),this.userMarker.setMap(this.map)}catch(t){}}},updateMapMarkers(){if(this.map&&this.bars&&0!==this.bars.length&&(this.markers.forEach(e=>e.setMap(null)),this.markers=[],this.bars.forEach(e=>{if(e.longitude&&e.latitude){const a=new AMap.Marker({position:[e.longitude,e.latitude],title:e.name,label:{content:e.name,direction:"right"},icon:new AMap.Icon({size:new AMap.Size(32,32),image:"https://webapi.amap.com/theme/v1.3/markers/n/mid.png",imageOffset:new AMap.Pixel(0,0)})}),t=new AMap.InfoWindow({content:`\n              <div style="padding: 10px; min-width: 200px;">\n                <h3 style="margin: 0 0 8px 0; font-size: 16px; color: #333;">${e.name}</h3>\n                <p style="margin: 4px 0; color: #666; font-size: 14px;">${e.address}</p>\n                ${e.distance?`<p style="margin: 4px 0; color: #409EFF; font-size: 14px;">距离: ${e.distance.toFixed(2)} 公里</p>`:""}\n                ${e.avgRating?`<p style="margin: 4px 0; color: #666; font-size: 14px;">评分: ${e.avgRating.toFixed(1)}</p>`:""}\n              </div>\n            `,offset:new AMap.Pixel(0,-30)});a.on("click",()=>{t.open(this.map,a.getPosition())}),a.setMap(this.map),this.markers.push(a)}}),this.markers.length>0))try{const e=[...this.markers];this.userMarker&&e.push(this.userMarker),this.map.setFitView(e,!1,[50,50,50,50])}catch(e){}}}},L=t(6262);const F=(0,L.A)(A,[["render",M],["__scopeId","data-v-6ad31a1b"]]);var _=F},6901:function(e,a,t){t.d(a,{BG:function(){return n},Bk:function(){return o},FC:function(){return u},HK:function(){return h},K6:function(){return p},KJ:function(){return c},N$:function(){return m},lU:function(){return s},pM:function(){return l},v7:function(){return d},w9:function(){return r}});var i=t(7277);const s=e=>(0,i.A)({url:"/bars/register",method:"post",data:e}),n=e=>(0,i.A)({url:`/bars/${e}`,method:"get"}),r=e=>(0,i.A)({url:"/bars/nearby",method:"get",params:e}),o=e=>(0,i.A)({url:`/bars/city/${e}`,method:"get"}),l=e=>(0,i.A)({url:"/bars/search",method:"get",params:e}),c=()=>(0,i.A)({url:"/bars/applications/my",method:"get"}),d=e=>(0,i.A)({url:"/bars/reviews",method:"post",data:e}),u=e=>(0,i.A)({url:`/bars/${e}/reviews`,method:"get"}),h=e=>(0,i.A)({url:`/bars/reviews/${e}`,method:"delete"}),p=e=>(0,i.A)({url:"/bars/recommend",method:"get",params:e}),m=e=>{const a={};return e&&Array.isArray(e)&&e.length>0&&(a.alcoholIds=e),(0,i.A)({url:"/bars/my",method:"get",params:a})}}}]);
//# sourceMappingURL=99.2e1e00ee.js.map